---
phase: 03-publishing-distribution
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - .github/workflows/release.yml
  - .github/workflows/publish.yml
autonomous: false

user_setup:
  - service: npm
    why: "First publish must be manual (OIDC trusted publishing requires package to exist on npmjs.com)"
    env_vars:
      - name: NPM_TOKEN
        source: "npmjs.com -> Access Tokens -> Generate New Token -> Granular Access Token (publish permission for passive-docs-index)"
    dashboard_config:
      - task: "Configure OIDC Trusted Publishing after first publish"
        location: "npmjs.com -> passive-docs-index -> Settings -> Trusted Publishers -> Add GitHub Actions"
        details: "Repository: syx-labs/passive-docs-index, Workflow: publish.yml, Environment: (leave blank)"

must_haves:
  truths:
    - "release.yml creates/updates a Version Packages PR when changesets exist on main"
    - "publish.yml triggers on push to main with package.json path filter, checks if version changed vs npm registry, and publishes with OIDC provenance"
    - "publish.yml uses npm >= 11.5.1 for OIDC trusted publishing support"
    - "publish.yml has id-token: write permission for OIDC and runs npm publish --provenance --access public"
    - "CI workflow runs build (including types) before publish to ensure dist/ is fresh"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "Changesets version PR automation on push to main"
      contains: "changesets/action"
    - path: ".github/workflows/publish.yml"
      provides: "npm publish with OIDC provenance on version change"
      contains: "npm publish --provenance"
  key_links:
    - from: ".github/workflows/release.yml"
      to: ".changeset/config.json"
      via: "changesets/action reads changeset config"
      pattern: "changesets/action"
    - from: ".github/workflows/publish.yml"
      to: "package.json"
      via: "version comparison and npm publish"
      pattern: "npm publish --provenance"
    - from: ".github/workflows/publish.yml"
      to: "dist/"
      via: "bun run build before publish"
      pattern: "bun run build"
---

<objective>
Create GitHub Actions workflows for automated versioning (via Changesets) and npm publishing with OIDC provenance.

Purpose: Automate the release pipeline so that merging changeset PRs to main triggers version bumps, CHANGELOG generation, and npm publishing with cryptographic provenance -- zero manual steps after initial setup.

Output: Two new GitHub Actions workflows (release.yml for version PRs, publish.yml for npm publish with OIDC), plus a checkpoint for first-publish bootstrapping.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-publishing-distribution/03-RESEARCH.md
@.planning/phases/03-publishing-distribution/03-01-SUMMARY.md
@.github/workflows/ci.yml
@package.json
@.changeset/config.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create release.yml and publish.yml workflows</name>
  <files>.github/workflows/release.yml, .github/workflows/publish.yml</files>
  <action>
  1. Create `.github/workflows/release.yml` -- Changesets Version PR automation:
     ```yaml
     name: Release

     on:
       push:
         branches: [main]

     concurrency: ${{ github.workflow }}-${{ github.ref }}

     jobs:
       release:
         name: Version Packages
         runs-on: ubuntu-latest
         permissions:
           contents: write
           pull-requests: write
         steps:
           - uses: actions/checkout@v4
           - uses: oven-sh/setup-bun@v2
           - run: bun install
           - uses: changesets/action@v1
             with:
               title: "chore(release): version packages"
               commit: "chore(release): version packages"
             env:
               GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
     ```

     Key design decisions (per research):
     - Triggered on push to main only (not on PRs)
     - Uses `concurrency` to prevent parallel runs
     - Does NOT include publish step (split workflow pattern, per changesets/action issue #515)
     - `GITHUB_TOKEN` is sufficient for PR creation (no PAT needed)

  2. Create `.github/workflows/publish.yml` -- npm publish with OIDC provenance:
     ```yaml
     name: Publish

     on:
       push:
         branches: [main]
         paths:
           - 'package.json'

     concurrency:
       group: ${{ github.workflow }}-${{ github.ref }}
       cancel-in-progress: false

     jobs:
       check-version:
         name: Check Version Change
         runs-on: ubuntu-latest
         outputs:
           should_publish: ${{ steps.check.outputs.changed }}
           current_version: ${{ steps.check.outputs.current }}
         steps:
           - uses: actions/checkout@v4
           - name: Compare with npm registry
             id: check
             run: |
               CURRENT=$(node -p "require('./package.json').version")
               PUBLISHED=$(npm view passive-docs-index version 2>/dev/null || echo "0.0.0")
               echo "current=$CURRENT" >> "$GITHUB_OUTPUT"
               if [ "$CURRENT" != "$PUBLISHED" ]; then
                 echo "changed=true" >> "$GITHUB_OUTPUT"
                 echo "Version changed: $PUBLISHED -> $CURRENT"
               else
                 echo "changed=false" >> "$GITHUB_OUTPUT"
                 echo "Version unchanged: $CURRENT"
               fi

       publish:
         name: Publish to npm
         needs: check-version
         if: needs.check-version.outputs.should_publish == 'true'
         runs-on: ubuntu-latest
         permissions:
           contents: read
           id-token: write
         steps:
           - uses: actions/checkout@v4

           - uses: oven-sh/setup-bun@v2

           - uses: actions/setup-node@v4
             with:
               node-version: '22.x'
               registry-url: 'https://registry.npmjs.org'

           # npm >= 11.5.1 required for OIDC Trusted Publishing
           - name: Upgrade npm for OIDC support
             run: npm install -g npm@latest

           - name: Verify npm version
             run: |
               NPM_VERSION=$(npm --version)
               echo "npm version: $NPM_VERSION"
               # Verify major version is >= 11
               MAJOR=$(echo "$NPM_VERSION" | cut -d. -f1)
               if [ "$MAJOR" -lt 11 ]; then
                 echo "::error::npm version $NPM_VERSION is too old for OIDC. Need >= 11.5.1"
                 exit 1
               fi

           - run: bun install

           - name: Build
             run: bun run build

           - name: Verify build artifacts
             run: |
               # Verify essential files exist
               test -f dist/cli.js || { echo "::error::dist/cli.js missing"; exit 1; }
               test -f dist/index.js || { echo "::error::dist/index.js missing"; exit 1; }
               test -f dist/index.d.ts || { echo "::error::dist/index.d.ts missing"; exit 1; }
               # Verify shebang
               head -1 dist/cli.js | grep -q "#!/usr/bin/env node" || { echo "::error::dist/cli.js missing shebang"; exit 1; }
               echo "Build artifacts verified"

           - name: Publish with provenance
             run: npm publish --provenance --access public
     ```

     Key design decisions:
     - Triggered on push to main ONLY when package.json changes (path filter)
     - `cancel-in-progress: false` to never cancel a publish mid-flight
     - Two-job design: check-version gates publish (avoids unnecessary OIDC attempts)
     - `registry-url: 'https://registry.npmjs.org'` in setup-node is REQUIRED (writes .npmrc for auth)
     - `id-token: write` permission enables OIDC (no NPM_TOKEN secret needed after trusted publishing configured)
     - npm upgraded to latest for OIDC support (Node 22 LTS ships npm 10.x which is too old)
     - Build artifacts verified before publish (shebang, .d.ts, bundle existence)
     - `--access public` required since package name is unscoped but npm defaults may vary

  3. Verify both workflow files are valid YAML:
     - Run a YAML syntax check (e.g., `node -e "require('yaml').parse(require('fs').readFileSync('.github/workflows/release.yml','utf8'))"`)
     - Same for publish.yml
  </action>
  <verify>
  Both `.github/workflows/release.yml` and `.github/workflows/publish.yml` exist. YAML is valid (parse without error). release.yml contains `changesets/action@v1`. publish.yml contains `npm publish --provenance`, `id-token: write`, `registry-url`, and npm version upgrade step.
  </verify>
  <done>
  Two workflows created: release.yml (creates version PRs via changesets/action on push to main) and publish.yml (publishes to npm with OIDC provenance when package.json version changes on main). Both are valid YAML. Publish workflow upgrades npm for OIDC, verifies build artifacts, and uses --provenance --access public.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: First publish bootstrapping and OIDC configuration</name>
  <what-built>
  Complete release pipeline: package.json configured for npm (correct files, exports, types, repository URL), two-step build producing JS bundles + .d.ts declarations, Changesets initialized for version management, release.yml for automated version PRs, publish.yml for OIDC-based npm publishing with provenance.

  NOTE: The package `passive-docs-index` does not yet exist on npmjs.com. OIDC Trusted Publishing cannot be configured until the package exists. A manual first publish is required to bootstrap the process.
  </what-built>
  <how-to-verify>
  **Step 1: Verify the build pipeline locally**
  ```bash
  bun run build
  npm pack --dry-run
  ```
  Confirm dist/cli.js (with shebang), dist/index.js, dist/index.d.ts are all listed. No templates/ directory.

  **Step 2: Test CLI from packed tarball (optional but recommended)**
  ```bash
  npm pack
  # In a temp directory:
  npm install /path/to/passive-docs-index-0.2.0.tgz
  npx pdi --help
  ```
  Confirm help output displays without errors.

  **Step 3: First manual publish to npm**
  This is a one-time bootstrapping step. OIDC cannot work until the package exists.
  ```bash
  # Create a granular access token at npmjs.com:
  # npmjs.com -> Access Tokens -> Generate New Token -> Granular Access Token
  # Permissions: Read and write (for publish)
  # Packages: passive-docs-index (or all packages)

  npm login   # or use NPM_TOKEN env var
  npm publish --access public
  ```

  **Step 4: Configure OIDC Trusted Publishing on npmjs.com**
  After the first publish succeeds:
  1. Go to npmjs.com -> passive-docs-index -> Settings -> Trusted Publishers
  2. Click "Add GitHub Actions"
  3. Repository owner: `syx-labs`
  4. Repository name: `passive-docs-index`
  5. Workflow filename: `publish.yml`
  6. Environment: (leave blank)

  **Step 5: Verify automated pipeline (after merge to main)**
  1. Create a changeset: `bunx changeset` -> select minor/patch -> describe change
  2. Push to main (or merge PR)
  3. Verify release.yml creates a "Version Packages" PR
  4. Merge the version PR
  5. Verify publish.yml triggers and publishes to npm
  6. Check npmjs.com/package/passive-docs-index for provenance badge

  Type "approved" when first publish and OIDC are configured, or describe any issues.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `.github/workflows/release.yml` exists with changesets/action for version PR automation
2. `.github/workflows/publish.yml` exists with OIDC provenance publishing
3. publish.yml has: id-token write permission, npm version upgrade, build verification, --provenance flag
4. release.yml has: contents write + pull-requests write permissions, concurrency, GITHUB_TOKEN
5. Both workflows are valid YAML
6. First publish completed on npmjs.com (human verified)
7. OIDC Trusted Publishing configured on npmjs.com (human verified)
</verification>

<success_criteria>
- release.yml creates Version Packages PRs when changesets are merged to main
- publish.yml publishes to npm with OIDC provenance when version changes on main
- First publish bootstrapping completed (package exists on npmjs.com)
- OIDC Trusted Publishing configured (subsequent publishes need no tokens)
- Provenance badge visible on npmjs.com package page
</success_criteria>

<output>
After completion, create `.planning/phases/03-publishing-distribution/03-02-SUMMARY.md`
</output>
