---
phase: 03-publishing-distribution
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified: []
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "npm publish workflow triggers on GitHub release with OIDC provenance -- provenance badge visible on npmjs.com"
    - "release.yml creates a Version Packages PR when changesets are merged to main"
    - "publish.yml triggers automatically when the version PR is merged and publishes with --provenance"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "Changesets version PR automation -- must be on main branch"
      contains: "changesets/action"
    - path: ".github/workflows/publish.yml"
      provides: "npm publish with OIDC provenance -- must be on main branch"
      contains: "npm publish --provenance"
  key_links:
    - from: "main branch"
      to: ".github/workflows/release.yml"
      via: "push to main triggers workflow"
      pattern: "on:.*push:.*branches:.*main"
    - from: ".github/workflows/publish.yml"
      to: "npmjs.com"
      via: "OIDC provenance publish on version change"
      pattern: "npm publish --provenance"
    - from: "npmjs.com package page"
      to: "GitHub Actions build"
      via: "provenance badge linking to attestation"
      pattern: "provenance"
---

<objective>
Close the remaining gap in Phase 3: merge workflows to main and verify the automated OIDC provenance publishing pipeline works end-to-end.

Purpose: Phase 3 scored 4/5 truths verified. Truth #2 ("npm publish workflow triggers on GitHub release with OIDC provenance -- provenance badge visible on npmjs.com") is PARTIAL because the workflows (release.yml, publish.yml) exist on `feat/v0.2.0-context7-integration` but have not been merged to main yet. v0.2.0 was published manually without provenance (bootstrapping requirement). This plan merges the feature branch, creates a patch changeset to trigger the pipeline, and verifies OIDC provenance appears on npmjs.com.

Output: Workflows operational on main, automated publish triggered, provenance attestations verified on npmjs.com.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-publishing-distribution/03-VERIFICATION.md
@.planning/phases/03-publishing-distribution/03-01-SUMMARY.md
@.planning/phases/03-publishing-distribution/03-02-SUMMARY.md
@.github/workflows/release.yml
@.github/workflows/publish.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Merge feature branch to main and create patch changeset</name>
  <files></files>
  <action>
  This task brings the workflows to main and seeds a changeset to trigger the release pipeline.

  1. **Create and merge PR from feat/v0.2.0-context7-integration to main:**
     - Use `gh pr create` to create the PR (if one does not already exist)
     - Title: "feat: v0.2.0 Context7 integration with CI/CD and publishing"
     - The PR includes ALL work from phases 1-3 (testing, CI/CD, publishing workflows)
     - Merge the PR using `gh pr merge --merge` (merge commit, not squash -- preserves commit history)
     - If CI checks are required and passing, merge will proceed. If checks are pending, wait for them.

  2. **After merge, switch to main and pull:**
     ```
     git checkout main && git pull origin main
     ```

  3. **Create a patch changeset to trigger the release pipeline:**
     ```
     bunx changeset add --empty
     ```
     This creates an empty changeset file in `.changeset/`. If `--empty` is not supported, create a changeset file manually:
     - Create `.changeset/<random-name>.md` with content:
       ```
       ---
       "passive-docs-index": patch
       ---

       chore: verify automated release pipeline with OIDC provenance
       ```

  4. **Commit and push the changeset to main:**
     ```
     git add .changeset/
     git commit -m "chore: add changeset for pipeline verification"
     git push origin main
     ```

  This push to main will trigger release.yml, which should create a "Version Packages" PR via changesets/action.
  </action>
  <verify>
  `git branch` shows main is checked out. `git log --oneline -1 origin/main` shows the merge commit or the changeset commit. The changeset file exists in `.changeset/` directory. `gh run list --workflow=release.yml --limit=1` shows a workflow run was triggered.
  </verify>
  <done>
  Feature branch merged to main. All workflows (release.yml, publish.yml, ci.yml) are now on the main branch. A patch changeset has been pushed to main, triggering the release.yml workflow.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify automated release pipeline and OIDC provenance</name>
  <what-built>
  The feature branch has been merged to main and a patch changeset pushed. This should trigger the full automated release pipeline:
  1. release.yml (triggered by push to main) runs changesets/action, which detects the changeset and creates a "Version Packages" PR
  2. When the Version Packages PR is merged, package.json version bumps and CHANGELOG.md updates
  3. publish.yml (triggered by package.json change on main) detects the version change and publishes to npm with --provenance
  </what-built>
  <how-to-verify>
  **Step 1: Verify release.yml created a Version Packages PR**
  ```bash
  gh run list --workflow=release.yml --limit=3
  gh pr list --search="Version Packages" --state=open
  ```
  Expected: A PR titled "chore(release): version packages" exists, created by github-actions bot. The PR should bump the version in package.json (e.g., 0.2.0 -> 0.2.1) and update CHANGELOG.md.

  If no PR appears within 5 minutes:
  - Check workflow run status: `gh run list --workflow=release.yml --limit=1`
  - Check workflow logs: `gh run view <run-id> --log`
  - Common issue: changesets/action may skip if no changeset files are found (verify `.changeset/*.md` exists with package entry)

  **Step 2: Merge the Version Packages PR**
  ```bash
  gh pr merge <pr-number> --merge
  ```
  This triggers publish.yml because package.json changed on main.

  **Step 3: Verify publish.yml triggered and succeeded**
  ```bash
  gh run list --workflow=publish.yml --limit=3
  gh run view <run-id>
  ```
  Expected: publish.yml runs, check-version job detects version change (e.g., 0.2.1 > 0.2.0 on registry), publish job runs and succeeds.

  If publish fails:
  - Check run logs: `gh run view <run-id> --log`
  - OIDC error: Verify trusted publisher config on npmjs.com matches exactly (workflow: publish.yml, repo: syx-labs/passive-docs-index, no environment)
  - npm version error: Verify npm was upgraded to >= 11.5.1 in the logs
  - Build error: Check if `bun run build` succeeded in the logs

  **Step 4: Verify provenance on npmjs.com**
  Visit: https://www.npmjs.com/package/passive-docs-index
  Expected:
  - New version (e.g., 0.2.1) is listed
  - A "Provenance" badge/section is visible on the package page
  - Clicking provenance shows attestation linking to the GitHub Actions build

  Alternative CLI verification:
  ```bash
  npm view passive-docs-index --json | jq '.dist.attestations'
  ```
  or
  ```bash
  npm audit signatures
  ```

  **Step 5: Verify CHANGELOG.md was updated**
  ```bash
  git pull origin main
  cat CHANGELOG.md
  ```
  Expected: CHANGELOG.md has an entry for the new version with the changeset description.

  Type "approved" when all steps pass, or describe any issues encountered.
  </how-to-verify>
  <resume-signal>Type "approved" when provenance badge is visible on npmjs.com, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Feature branch merged to main -- all workflows present on main branch
2. release.yml triggered by push to main and created a "Version Packages" PR
3. Merging the version PR triggered publish.yml
4. publish.yml built artifacts, compared versions, and published to npm with --provenance
5. New version visible on npmjs.com with provenance badge/attestations
6. CHANGELOG.md updated with new version entry
</verification>

<success_criteria>
- Workflows are operational on main branch (not orphaned on feature branch)
- release.yml successfully creates Version Packages PRs from changesets
- publish.yml successfully publishes to npm with OIDC provenance
- Provenance badge is visible on npmjs.com package page for the new version
- Truth #2 moves from PARTIAL to VERIFIED
- CICD-02 (publish workflow) and CICD-03 (provenance badges) requirements are SATISFIED
</success_criteria>

<output>
After completion, create `.planning/phases/03-publishing-distribution/03-03-SUMMARY.md`
</output>
