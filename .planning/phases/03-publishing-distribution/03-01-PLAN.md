---
phase: 03-publishing-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.build.json
  - .changeset/config.json
  - .changeset/README.md
autonomous: true

must_haves:
  truths:
    - "Running `npx pdi --help` from a packed tarball shows CLI help without errors"
    - "IDE users importing passive-docs-index get full type information (.d.ts files present in package)"
    - "npm pack output contains only dist/ files, package.json, README, and LICENSE -- no extraneous directories"
    - "Changesets can track and version changes to the package"
    - "package.json metadata is valid for npm OIDC publishing (repository URL, bin, types, exports, engines all correct)"
  artifacts:
    - path: "tsconfig.build.json"
      provides: "Declaration-only emit configuration extending base tsconfig"
      contains: "emitDeclarationOnly"
    - path: ".changeset/config.json"
      provides: "Changesets configuration for public npm package with GitHub changelog"
      contains: "changelog-github"
    - path: "package.json"
      provides: "Updated build scripts, files array, and repository URL"
      contains: "build:types"
  key_links:
    - from: "package.json"
      to: "tsconfig.build.json"
      via: "build:types script"
      pattern: "tsc -p tsconfig\\.build\\.json"
    - from: "package.json"
      to: "dist/index.d.ts"
      via: "types field"
      pattern: "\"types\".*dist/index\\.d\\.ts"
    - from: "package.json"
      to: "dist/cli.js"
      via: "bin field"
      pattern: "\"pdi\".*dist/cli\\.js"
    - from: ".changeset/config.json"
      to: "package.json"
      via: "changeset version reads/writes version"
      pattern: "\"access\".*public"
---

<objective>
Configure the package for npm distribution with type declarations and changelog automation.

Purpose: Make the package publishable to npm with correct metadata, build pipeline that produces JS bundles + .d.ts declarations, and Changesets for version/changelog management. This is the foundation that the publish workflow (Plan 02) depends on.

Output: Updated package.json with corrected fields and build scripts, tsconfig.build.json for declaration emit, initialized .changeset/ directory with GitHub changelog integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-publishing-distribution/03-RESEARCH.md
@package.json
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tsconfig.build.json and update package.json for two-step build</name>
  <files>package.json, tsconfig.build.json</files>
  <action>
  1. Create `tsconfig.build.json` that extends `./tsconfig.json` with these overrides:
     - `noEmit: false` (override base tsconfig)
     - `emitDeclarationOnly: true`
     - `declaration: true`
     - `declarationMap: true`
     - `outDir: "./dist"`
     - `rootDir: "./src"`
     - Remove `types: ["bun-types"]` from compilerOptions (bun-types has ambient declarations that conflict with declaration emit -- causes errors for Bun-specific APIs)
     - `include: ["src/**/*"]`
     - `exclude: ["node_modules", "dist", "tests"]`

  2. Update `package.json`:
     a. **scripts.build**: Split into two-step build:
        - `"build": "bun run build:js && bun run build:types"`
        - `"build:js": "bun build src/cli.ts --outfile dist/cli.js --target node --format esm && bun build src/index.ts --outfile dist/index.js --target node --format esm"`
        - `"build:types": "tsc -p tsconfig.build.json"`
     b. **files**: Remove `"templates"` from the array (templates directory is empty; templates are code-defined in src/lib/templates.ts and bundled into dist/index.js). Result: `"files": ["dist"]`
     c. **repository.url**: Change from `"https://github.com/syx-labs/passive-docs-index"` to `"git+https://github.com/syx-labs/passive-docs-index.git"` (required for npm OIDC trusted publishing URL matching)
     d. Keep all other fields unchanged (bin, main, types, exports, engines, dependencies, etc.)
  </action>
  <verify>
  `tsconfig.build.json` exists with `emitDeclarationOnly: true`. `package.json` has `build:types` script, `files: ["dist"]`, and `repository.url` starts with `git+`.
  </verify>
  <done>
  tsconfig.build.json created for declaration emit. package.json updated with two-step build scripts, corrected files array (no templates/), and OIDC-compatible repository URL.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build, verify artifacts, and validate package.json metadata</name>
  <files>package.json</files>
  <action>
  1. Run `bun run build` and verify all artifacts:
     - `dist/cli.js` exists and starts with `#!/usr/bin/env node`
     - `dist/index.js` exists
     - `dist/index.d.ts` exists (from tsc)
     - If tsc fails on Bun-specific types, add specific exclusions to tsconfig.build.json

  2. Run `npm pack --dry-run` and verify output includes:
     - `dist/cli.js`, `dist/index.js`
     - `dist/index.d.ts`, `dist/index.d.ts.map`
     - `package.json`, `README.md`, `LICENSE`
     - Does NOT include `templates/` directory

  3. Validate package.json metadata fields (CICD-04 requirement):
     Run a programmatic check to verify:
     a. **bin.pdi** points to `./dist/cli.js` AND `dist/cli.js` has executable shebang (`#!/usr/bin/env node`)
     b. **types** field is `./dist/index.d.ts` AND `dist/index.d.ts` actually exists after build
     c. **exports["."].types** is `./dist/index.d.ts` (required for modern TS module resolution)
     d. **exports["."].import** is `./dist/index.js` AND `dist/index.js` actually exists after build
     e. **engines.node** is `>=18.0.0` (matches project's Node compatibility target)
     f. **main** is `./dist/index.js`

     Verification script (run with `node -e` or `bun -e`):
     ```
     const pkg = require('./package.json');
     const fs = require('fs');
     const checks = [
       [pkg.bin?.pdi === './dist/cli.js', 'bin.pdi must be ./dist/cli.js'],
       [pkg.types === './dist/index.d.ts', 'types must be ./dist/index.d.ts'],
       [pkg.exports?.['.']?.types === './dist/index.d.ts', 'exports["."].types must be ./dist/index.d.ts'],
       [pkg.exports?.['.']?.import === './dist/index.js', 'exports["."].import must be ./dist/index.js'],
       [pkg.engines?.node === '>=18.0.0', 'engines.node must be >=18.0.0'],
       [pkg.main === './dist/index.js', 'main must be ./dist/index.js'],
       [fs.existsSync('dist/cli.js'), 'dist/cli.js must exist'],
       [fs.existsSync('dist/index.js'), 'dist/index.js must exist'],
       [fs.existsSync('dist/index.d.ts'), 'dist/index.d.ts must exist'],
       [fs.readFileSync('dist/cli.js','utf8').startsWith('#!/usr/bin/env node'), 'dist/cli.js must have shebang'],
       [pkg.repository?.url === 'git+https://github.com/syx-labs/passive-docs-index.git', 'repository.url OIDC format'],
     ];
     const failures = checks.filter(([ok]) => !ok);
     if (failures.length) { failures.forEach(([,msg]) => console.error('FAIL:', msg)); process.exit(1); }
     console.log('All package.json metadata checks passed');
     ```

  4. Verify no regressions: `bun run typecheck` and `bun test` still pass.
  </action>
  <verify>
  `bun run build` exits 0. All 11 metadata checks pass. `npm pack --dry-run 2>&1 | grep -c "\.d\.ts"` shows at least 1. `bun run typecheck` and `bun test` pass.
  </verify>
  <done>
  Two-step build works end-to-end: `bun run build` produces dist/cli.js (with shebang), dist/index.js, and dist/index.d.ts. All package.json metadata validated: bin points to executable with shebang, types and exports.types point to emitted .d.ts, engines specifies >=18.0.0, repository.url in OIDC format. `npm pack --dry-run` output includes dist/ with type declarations, excludes templates/. No regressions in typecheck or tests.
  </done>
</task>

<task type="auto">
  <name>Task 3: Initialize Changesets with GitHub changelog integration</name>
  <files>.changeset/config.json, .changeset/README.md</files>
  <action>
  1. Install Changesets dependencies:
     ```
     bun add -d @changesets/cli @changesets/changelog-github
     ```

  2. Initialize Changesets:
     ```
     bunx changeset init
     ```
     This creates `.changeset/` directory with `config.json` and `README.md`.

  3. Replace the auto-generated `.changeset/config.json` with the correct config for this project:
     ```json
     {
       "$schema": "https://unpkg.com/@changesets/config@3.0.2/schema.json",
       "changelog": [
         "@changesets/changelog-github",
         { "repo": "syx-labs/passive-docs-index" }
       ],
       "commit": false,
       "fixed": [],
       "linked": [],
       "access": "public",
       "baseBranch": "main",
       "updateInternalDependencies": "patch",
       "ignore": []
     }
     ```
     Key settings:
     - `changelog`: Uses `@changesets/changelog-github` for PR-linked changelog entries with contributor attribution
     - `access: "public"`: Required for public npm packages (scoped packages default to restricted)
     - `baseBranch: "main"`: The branch Changesets compares against for version PRs
     - `commit: false`: Don't auto-commit version bumps (the GitHub Action handles this)

  4. Verify Changesets works:
     ```
     bunx changeset status
     ```
     Should report "No changesets present" (not an error).

  5. Verify `bunx changeset version` can be run in dry-run mode (check it doesn't error). Since there are no changesets, it should be a no-op.
  </action>
  <verify>
  `.changeset/config.json` exists with `"access": "public"` and `"changelog-github"`. `bunx changeset status` exits without error.
  </verify>
  <done>
  Changesets is initialized with correct config for public single-package repo. `@changesets/changelog-github` configured for PR-linked CHANGELOG entries. `bunx changeset status` runs successfully.
  </done>
</task>

</tasks>

<verification>
1. `bun run build` succeeds and produces: dist/cli.js (with shebang), dist/index.js, dist/index.d.ts
2. `npm pack --dry-run` shows dist/ files, type declarations, no templates/ directory
3. Package.json metadata validated: bin, types, exports.types, engines, main, repository.url all correct
4. `.changeset/config.json` exists with correct settings
5. `bunx changeset status` runs without error
6. `bun run typecheck` still passes (no regression from tsconfig.build.json)
7. `bun test` still passes (no regression from package.json changes)
</verification>

<success_criteria>
- Two-step build (JS + types) works: `bun run build` produces bundles and declarations
- Package contents are correct: `npm pack --dry-run` includes dist/ with .d.ts, excludes templates/
- Package metadata validated: bin->executable with shebang, types->.d.ts, exports.types set, engines.node specified
- Changesets ready for versioning: `.changeset/` initialized, `changeset status` works
- No regressions: `bun run typecheck` and `bun test` pass
- repository.url matches npm OIDC format
</success_criteria>

<output>
After completion, create `.planning/phases/03-publishing-distribution/03-01-SUMMARY.md`
</output>
