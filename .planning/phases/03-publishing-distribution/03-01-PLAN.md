---
phase: 03-publishing-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.build.json
  - .changeset/config.json
  - .changeset/README.md
autonomous: true

must_haves:
  truths:
    - "bun run build produces dist/cli.js, dist/index.js, and dist/index.d.ts without errors"
    - "npm pack --dry-run shows dist/ and type declarations but NOT an empty templates/ directory"
    - "tsconfig.build.json emits .d.ts files from src/ into dist/"
    - ".changeset/ directory exists with valid config for public single-package repo"
    - "repository.url in package.json matches npm OIDC format (git+https://.../.git)"
  artifacts:
    - path: "tsconfig.build.json"
      provides: "Declaration-only emit configuration extending base tsconfig"
      contains: "emitDeclarationOnly"
    - path: ".changeset/config.json"
      provides: "Changesets configuration for public npm package with GitHub changelog"
      contains: "changelog-github"
    - path: "package.json"
      provides: "Updated build scripts, files array, and repository URL"
      contains: "build:types"
  key_links:
    - from: "package.json"
      to: "tsconfig.build.json"
      via: "build:types script"
      pattern: "tsc -p tsconfig\\.build\\.json"
    - from: "package.json"
      to: "dist/index.d.ts"
      via: "types field"
      pattern: "\"types\".*dist/index\\.d\\.ts"
    - from: ".changeset/config.json"
      to: "package.json"
      via: "changeset version reads/writes version"
      pattern: "\"access\".*public"
---

<objective>
Configure the package for npm distribution with type declarations and changelog automation.

Purpose: Make the package publishable to npm with correct metadata, build pipeline that produces JS bundles + .d.ts declarations, and Changesets for version/changelog management. This is the foundation that the publish workflow (Plan 02) depends on.

Output: Updated package.json with corrected fields and build scripts, tsconfig.build.json for declaration emit, initialized .changeset/ directory with GitHub changelog integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-publishing-distribution/03-RESEARCH.md
@package.json
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update package.json and create tsconfig.build.json for two-step build</name>
  <files>package.json, tsconfig.build.json</files>
  <action>
  1. Create `tsconfig.build.json` that extends `./tsconfig.json` with these overrides:
     - `noEmit: false` (override base tsconfig)
     - `emitDeclarationOnly: true`
     - `declaration: true`
     - `declarationMap: true`
     - `outDir: "./dist"`
     - `rootDir: "./src"`
     - Remove `types: ["bun-types"]` from compilerOptions (bun-types has ambient declarations that conflict with declaration emit -- causes errors for Bun-specific APIs)
     - `include: ["src/**/*"]`
     - `exclude: ["node_modules", "dist", "tests"]`

  2. Update `package.json`:
     a. **scripts.build**: Split into two-step build:
        - `"build": "bun run build:js && bun run build:types"`
        - `"build:js": "bun build src/cli.ts --outfile dist/cli.js --target node --format esm && bun build src/index.ts --outfile dist/index.js --target node --format esm"`
        - `"build:types": "tsc -p tsconfig.build.json"`
     b. **files**: Remove `"templates"` from the array (templates directory is empty; templates are code-defined in src/lib/templates.ts and bundled into dist/index.js). Result: `"files": ["dist"]`
     c. **repository.url**: Change from `"https://github.com/syx-labs/passive-docs-index"` to `"git+https://github.com/syx-labs/passive-docs-index.git"` (required for npm OIDC trusted publishing URL matching)
     d. Keep all other fields unchanged (bin, main, types, exports, engines, dependencies, etc.)

  3. Run `bun run build` and verify:
     - `dist/cli.js` exists and starts with `#!/usr/bin/env node`
     - `dist/index.js` exists
     - `dist/index.d.ts` exists (from tsc)
     - If tsc fails on Bun-specific types, add specific exclusions to tsconfig.build.json

  4. Run `npm pack --dry-run` and verify output includes:
     - `dist/cli.js`, `dist/index.js`
     - `dist/index.d.ts`, `dist/index.d.ts.map`
     - `package.json`, `README.md`, `LICENSE`
     - Does NOT include `templates/` directory
  </action>
  <verify>
  `bun run build` exits 0 producing both JS bundles and .d.ts files. `npm pack --dry-run 2>&1 | grep -c "\.d\.ts"` shows at least 1. `head -1 dist/cli.js` shows shebang line.
  </verify>
  <done>
  Two-step build works end-to-end: `bun run build` produces dist/cli.js (with shebang), dist/index.js, and dist/index.d.ts. `npm pack --dry-run` output includes dist/ with type declarations, excludes empty templates/ directory. repository.url has git+ prefix and .git suffix.
  </done>
</task>

<task type="auto">
  <name>Task 2: Initialize Changesets with GitHub changelog integration</name>
  <files>.changeset/config.json, .changeset/README.md</files>
  <action>
  1. Install Changesets dependencies:
     ```
     bun add -d @changesets/cli @changesets/changelog-github
     ```

  2. Initialize Changesets:
     ```
     bunx changeset init
     ```
     This creates `.changeset/` directory with `config.json` and `README.md`.

  3. Replace the auto-generated `.changeset/config.json` with the correct config for this project:
     ```json
     {
       "$schema": "https://unpkg.com/@changesets/config@3.0.2/schema.json",
       "changelog": [
         "@changesets/changelog-github",
         { "repo": "syx-labs/passive-docs-index" }
       ],
       "commit": false,
       "fixed": [],
       "linked": [],
       "access": "public",
       "baseBranch": "main",
       "updateInternalDependencies": "patch",
       "ignore": []
     }
     ```
     Key settings:
     - `changelog`: Uses `@changesets/changelog-github` for PR-linked changelog entries with contributor attribution
     - `access: "public"`: Required for public npm packages (scoped packages default to restricted)
     - `baseBranch: "main"`: The branch Changesets compares against for version PRs
     - `commit: false`: Don't auto-commit version bumps (the GitHub Action handles this)

  4. Verify Changesets works:
     ```
     bunx changeset status
     ```
     Should report "No changesets present" (not an error).

  5. Verify `bunx changeset version` can be run in dry-run mode (check it doesn't error). Since there are no changesets, it should be a no-op.
  </action>
  <verify>
  `.changeset/config.json` exists with `"access": "public"` and `"changelog-github"`. `bunx changeset status` exits without error.
  </verify>
  <done>
  Changesets is initialized with correct config for public single-package repo. `@changesets/changelog-github` configured for PR-linked CHANGELOG entries. `bunx changeset status` runs successfully.
  </done>
</task>

</tasks>

<verification>
1. `bun run build` succeeds and produces: dist/cli.js (with shebang), dist/index.js, dist/index.d.ts
2. `npm pack --dry-run` shows dist/ files, type declarations, no templates/ directory
3. `.changeset/config.json` exists with correct settings
4. `bunx changeset status` runs without error
5. `bun run typecheck` still passes (no regression from tsconfig.build.json)
6. `bun test` still passes (no regression from package.json changes)
</verification>

<success_criteria>
- Two-step build (JS + types) works: `bun run build` produces bundles and declarations
- Package contents are correct: `npm pack --dry-run` includes dist/ with .d.ts, excludes templates/
- Changesets ready for versioning: `.changeset/` initialized, `changeset status` works
- No regressions: `bun run typecheck` and `bun test` pass
- repository.url matches npm OIDC format
</success_criteria>

<output>
After completion, create `.planning/phases/03-publishing-distribution/03-01-SUMMARY.md`
</output>
