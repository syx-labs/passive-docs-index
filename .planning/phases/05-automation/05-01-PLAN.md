---
phase: 05-automation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/registry-client.ts
  - src/lib/freshness.ts
  - tests/unit/lib/registry-client.test.ts
  - tests/unit/lib/freshness.test.ts
autonomous: true

must_haves:
  truths:
    - "fetchLatestVersion returns the dist-tags.latest version for a valid npm package"
    - "fetchLatestVersions fetches multiple packages in parallel with concurrency limit of 5"
    - "Registry fetch uses abbreviated metadata Accept header for minimal payload"
    - "Registry fetch respects a 5-second timeout and returns null on timeout"
    - "checkVersionFreshness reports stale for major and minor version changes"
    - "checkVersionFreshness reports up-to-date for patch-only changes"
    - "checkFreshness detects orphaned frameworks (in config but not in package.json)"
    - "checkFreshness detects missing frameworks (in package.json but not in config)"
    - "Loose version strings (v18.2, 18.x, 4) are coerced to valid semver before comparison"
  artifacts:
    - path: "src/lib/registry-client.ts"
      provides: "npm registry API client with fetchLatestVersion and fetchLatestVersions"
      exports: ["fetchLatestVersion", "fetchLatestVersions", "NPM_REGISTRY_URL"]
    - path: "src/lib/freshness.ts"
      provides: "Freshness checking logic, exit codes, and result types"
      exports: ["checkVersionFreshness", "checkFreshness", "EXIT_CODES", "FreshnessStatus", "FreshnessResult", "ExitCode"]
    - path: "tests/unit/lib/registry-client.test.ts"
      provides: "Unit tests for registry client"
    - path: "tests/unit/lib/freshness.test.ts"
      provides: "Unit tests for freshness checker"
  key_links:
    - from: "src/lib/freshness.ts"
      to: "src/lib/registry-client.ts"
      via: "import fetchLatestVersions"
      pattern: "import.*fetchLatestVersions.*from.*registry-client"
    - from: "src/lib/freshness.ts"
      to: "semver"
      via: "import semver for coerce/diff"
      pattern: "import.*semver"
---

<objective>
Build the core freshness checking engine: an npm registry client and a freshness comparison module. These are pure logic modules with well-defined inputs and outputs, ideal for TDD.

Purpose: These modules are the foundation for both the `pdi status --check` CI gate and the postinstall hook. They must correctly handle version comparison edge cases (loose versions, coercion, major/minor vs patch thresholds) and registry communication (abbreviated metadata, timeouts, concurrency).

Output: Two tested modules (`registry-client.ts`, `freshness.ts`) with >90% coverage, ready for integration by plan 05-02.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-automation/05-RESEARCH.md
@src/lib/types.ts
@src/lib/errors.ts
@src/lib/config.ts
@src/lib/constants.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Registry client and freshness module with TDD</name>
  <files>
    src/lib/registry-client.ts
    src/lib/freshness.ts
    tests/unit/lib/registry-client.test.ts
    tests/unit/lib/freshness.test.ts
    package.json
  </files>
  <action>
**Install dependencies first:**
```bash
bun add semver
bun add -d @types/semver
```

**RED phase — Write failing tests first:**

**tests/unit/lib/registry-client.test.ts:**
Mock `global.fetch` (established pattern from phase 01 -- spyOn(global, 'fetch')).

Test cases for `fetchLatestVersion(packageName: string)`:
- Returns latest version string from dist-tags when registry responds 200
- Returns null when package not found (404)
- Throws error on non-404 HTTP errors (500, 403)
- Uses abbreviated metadata Accept header: `application/vnd.npm.install-v1+json; q=1.0, application/json; q=0.8, */*`
- Respects 5-second timeout via AbortSignal.timeout(5000)
- Handles network errors (fetch rejects) by throwing
- Properly encodes scoped package names (e.g., `@tanstack/react-query` -> `%40tanstack%2Freact-query`)

Test cases for `fetchLatestVersions(packageNames: string[])`:
- Fetches multiple packages and returns Map<string, string | null>
- Limits concurrency to 5 parallel requests (use p-limit)
- Handles mixed results (some succeed, some 404, some error)
- Returns empty map for empty input array

**tests/unit/lib/freshness.test.ts:**
Mock the registry client's `fetchLatestVersions` function.

Test cases for `checkVersionFreshness(indexedVersion, latestVersion)`:
- Returns `{ isStale: true, diffType: "major" }` for 18.0.0 -> 19.0.0
- Returns `{ isStale: true, diffType: "minor" }` for 18.0.0 -> 18.3.0
- Returns `{ isStale: false, diffType: "patch" }` for 18.2.0 -> 18.2.1
- Returns `{ isStale: false, diffType: null }` for same version (18.0.0 -> 18.0.0)
- Handles loose versions via semver.coerce: "18.x" -> 18.0.0, "v19" -> 19.0.0, "4" -> 4.0.0
- Returns `{ isStale: false, diffType: null }` for un-coercible versions (graceful fallback)

Test cases for `checkFreshness(config, packageJson)`:
- Reports "up-to-date" for frameworks where indexed version matches latest (major.minor)
- Reports "stale" for frameworks where latest has new major or minor version
- Reports "orphaned" for frameworks in config.frameworks but NOT in package.json dependencies
- Reports "missing" for frameworks in package.json (matching KNOWN_FRAMEWORKS) but NOT in config.frameworks
- Handles frameworks with no npm package mapping (timestamp-based check using lastUpdate and configurable staleDays, default 30)
- Returns correct exit code: SUCCESS(0) for all ok, STALE(1), MISSING(2), ORPHANED(3), MIXED(4) for multiple problem types
- Returns NETWORK_ERROR(5) when registry fetch fails

Test cases for `EXIT_CODES`:
- Verify all exit code constants: SUCCESS=0, STALE=1, MISSING=2, ORPHANED=3, MIXED=4, NETWORK_ERROR=5

**GREEN phase — Implement to pass tests:**

**src/lib/registry-client.ts:**
```typescript
export const NPM_REGISTRY_URL = "https://registry.npmjs.org";

export async function fetchLatestVersion(packageName: string): Promise<string | null> {
  // Fetch from NPM_REGISTRY_URL/{encodedPackageName}
  // Use Accept header for abbreviated metadata
  // Use AbortSignal.timeout(5000)
  // Return data["dist-tags"].latest or null on 404
  // Throw on other HTTP errors
}

export async function fetchLatestVersions(packageNames: string[]): Promise<Map<string, string | null>> {
  // Use p-limit(5) for concurrency control
  // Call fetchLatestVersion for each
  // Collect into Map, individual errors -> null entry
}
```

**src/lib/freshness.ts:**
```typescript
import semver from "semver";
import { fetchLatestVersions } from "./registry-client.js";
// Import types from config, constants

export const EXIT_CODES = {
  SUCCESS: 0,
  STALE: 1,
  MISSING: 2,
  ORPHANED: 3,
  MIXED: 4,
  NETWORK_ERROR: 5,
} as const;

export type ExitCode = (typeof EXIT_CODES)[keyof typeof EXIT_CODES];
export type FreshnessStatus = "up-to-date" | "stale" | "missing" | "orphaned";

export interface FreshnessResult {
  framework: string;
  displayName: string;
  indexedVersion: string;
  latestVersion: string | null;
  status: FreshnessStatus;
  diffType: string | null;
}

export interface FreshnessCheckOutput {
  results: FreshnessResult[];
  exitCode: ExitCode;
  summary: { total: number; stale: number; missing: number; orphaned: number; upToDate: number };
}

export function checkVersionFreshness(indexedVersion: string, latestVersion: string): { isStale: boolean; diffType: string | null } {
  // Use semver.coerce() on both versions
  // Use semver.diff() to get change type
  // isStale = diff is "major", "minor", "premajor", or "preminor"
}

export async function checkFreshness(
  config: PDIConfig,
  packageJson: { dependencies?: Record<string, string>; devDependencies?: Record<string, string> } | null,
  options?: { staleDays?: number }
): Promise<FreshnessCheckOutput> {
  // 1. Get all framework npm package names from KNOWN_FRAMEWORKS matching config.frameworks keys
  // 2. Fetch latest versions from registry via fetchLatestVersions
  // 3. For each framework in config.frameworks:
  //    - Find matching KNOWN_FRAMEWORK to get npm package name
  //    - If framework is in config but not in package.json deps -> "orphaned"
  //    - Compare indexed version vs latest using checkVersionFreshness
  // 4. For each dep in package.json that matches KNOWN_FRAMEWORKS but NOT in config -> "missing"
  // 5. Compute exit code: SUCCESS if all ok, single type if one issue type, MIXED if multiple types
  // 6. On network error from registry -> exit code NETWORK_ERROR
}
```

**REFACTOR phase:** Clean up, ensure consistent error handling, verify all tests pass with `bun test tests/unit/lib/registry-client.test.ts tests/unit/lib/freshness.test.ts`.

**Important implementation details per locked decisions:**
- Major + Minor threshold only (patch = ok) per CONTEXT.md
- npm registry is sole source of truth, no offline fallback
- Use `semver.coerce()` to handle loose versions (18.x, v19, etc.)
- Scoped packages: always use registry.npmjs.org (no custom registry support in v1)
- Orphaned = frameworks in config but no longer in package.json
- Missing = frameworks detectable via KNOWN_FRAMEWORKS in package.json but not in config
  </action>
  <verify>
```bash
bun test tests/unit/lib/registry-client.test.ts tests/unit/lib/freshness.test.ts
```
All tests pass. No type errors: `bunx tsc --noEmit`.
  </verify>
  <done>
- registry-client.ts fetches npm registry dist-tags with abbreviated metadata, 5s timeout, p-limit(5) concurrency
- freshness.ts compares indexed vs latest versions using semver.coerce()+diff(), reports stale/missing/orphaned with correct exit codes 0-5
- All edge cases tested: loose versions, scoped packages, 404s, network errors, mixed results
- semver and @types/semver added to package.json
  </done>
</task>

</tasks>

<verification>
```bash
# All new tests pass
bun test tests/unit/lib/registry-client.test.ts tests/unit/lib/freshness.test.ts

# Type checking passes
bunx tsc --noEmit

# Lint passes
bunx ultracite check

# Full test suite still passes (no regressions)
bun test
```
</verification>

<success_criteria>
1. `registry-client.ts` exports `fetchLatestVersion` and `fetchLatestVersions` with proper npm registry interaction
2. `freshness.ts` exports `checkVersionFreshness`, `checkFreshness`, `EXIT_CODES`, and all result types
3. All tests pass with >90% coverage on both new modules
4. semver.coerce() handles loose version strings (18.x, v19, 4) without errors
5. Exit codes are 0-5 matching the documented constants
6. Full test suite passes (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/05-automation/05-01-SUMMARY.md`
</output>
