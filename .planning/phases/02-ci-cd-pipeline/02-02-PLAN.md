---
phase: 02-ci-cd-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - README.md
autonomous: false

user_setup:
  - service: github-gist
    why: "Coverage badge data storage"
    env_vars:
      - name: GIST_SECRET
        source: "GitHub Settings -> Developer settings -> Personal access tokens -> Create token with 'gist' scope"
    dashboard_config:
      - task: "Create a Gist with filename coverage.json and content {}"
        location: "https://gist.github.com/ -> New Gist"
      - task: "Copy the Gist ID from the URL and add as repository variable COVERAGE_GIST_ID"
        location: "GitHub repo -> Settings -> Secrets and variables -> Actions -> Variables -> New repository variable"
      - task: "Add the PAT as repository secret GIST_SECRET"
        location: "GitHub repo -> Settings -> Secrets and variables -> Actions -> Secrets -> New repository secret"

must_haves:
  truths:
    - "CI status badge in README shows current build health (green/red)"
    - "Coverage badge in README shows current coverage percentage"
    - "Badge links point to the correct GitHub Actions workflow"
    - "CI workflow runs successfully on a real PR"
    - "Branch protection prevents direct push to main"
  artifacts:
    - path: "README.md"
      provides: "CI and coverage badges visible at top of README"
      contains: "img.shields.io"
  key_links:
    - from: "README.md"
      to: ".github/workflows/ci.yml"
      via: "Shields.io badge URL referencing workflow file"
      pattern: "github/actions/workflow/status.*ci.yml"
---

<objective>
Add CI and coverage badges to the README and verify the complete CI pipeline works end-to-end.

Purpose: Provide visible build health feedback and verify the CI workflow, branch protection, and coverage reporting all function correctly.
Output: Updated README.md with badges. Verified CI pipeline on a real PR.
</objective>

<execution_context>
@/Users/sleepy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sleepy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ci-cd-pipeline/02-01-SUMMARY.md
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CI and coverage badges to README</name>
  <files>README.md</files>
  <action>
Update the badge section at the top of `README.md` (lines 3-5) to add CI and coverage badges.

Current badges (keep these):
```markdown
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![TypeScript](https://img.shields.io/badge/TypeScript-5.x-blue.svg)](https://www.typescriptlang.org/)
[![Bun](https://img.shields.io/badge/Bun-1.x-f9f1e1.svg)](https://bun.sh/)
```

Add these two badges BEFORE the existing badges (CI status is most important):
```markdown
[![CI](https://img.shields.io/github/actions/workflow/status/syx-labs/passive-docs-index/ci.yml?branch=main&style=flat&label=CI)](https://github.com/syx-labs/passive-docs-index/actions/workflows/ci.yml)
[![Coverage](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/raw/coverage.json&label=Coverage)](https://github.com/syx-labs/passive-docs-index/actions/workflows/ci.yml)
```

Per user decision: Shields.io custom badges (not native GitHub badges). CI badge uses the `github/actions/workflow/status` shield type. Coverage badge uses the `endpoint` shield type pointing to a Gist JSON.

NOTE: The coverage badge URL uses a placeholder (`raw/coverage.json`) that will show "invalid" until the Gist is created and COVERAGE_GIST_ID is configured. Add a YAML comment in the workflow or a note in the badge markdown explaining this is expected until first push to main with Gist configured.

The final badge order should be: CI, Coverage, License, TypeScript, Bun.
  </action>
  <verify>
- README.md contains `img.shields.io/github/actions/workflow/status` (CI badge)
- README.md contains `img.shields.io/endpoint` (Coverage badge)
- README.md still contains the original License, TypeScript, and Bun badges
- Badge links point to `github.com/syx-labs/passive-docs-index/actions/workflows/ci.yml`
  </verify>
  <done>
README.md has 5 badges at the top: CI status, Coverage, License, TypeScript, Bun. CI badge uses Shields.io GitHub Actions workflow status endpoint. Coverage badge uses Shields.io endpoint pointing to Gist JSON.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete CI/CD pipeline for passive-docs-index:
1. GitHub Actions CI workflow (`.github/workflows/ci.yml`) with lint, typecheck, test, coverage
2. TypeScript problem matcher for inline annotations
3. Branch protection script (`scripts/setup-branch-protection.sh`)
4. CI and coverage badges in README

The CI workflow will automatically run when this branch is pushed and a PR is opened.
  </what-built>
  <how-to-verify>
**Automatic verification (CI should already be running):**
1. Push the current branch and open/update the PR targeting `main`
2. Check the GitHub Actions tab -- CI workflow should trigger
3. Verify the CI job runs: Lint -> Typecheck -> Test -> Coverage check
4. Verify lint errors (if any) appear as inline annotations on PR files
5. Verify a coverage report comment appears on the PR

**Branch protection setup (manual, one-time):**
6. Run `scripts/setup-branch-protection.sh` from the repo root (requires `gh` auth with admin access)
7. Verify in GitHub repo Settings -> Branches that main branch protection is active

**Coverage badge setup (manual, one-time -- can be deferred):**
8. Create a GitHub Gist with filename `coverage.json` and content `{}`
9. Create a GitHub PAT with `gist` scope
10. Add the PAT as repo secret `GIST_SECRET`
11. Add the Gist ID as repo variable `COVERAGE_GIST_ID`
12. Update the coverage badge URL in README.md to include the actual Gist username and ID

**Expected results:**
- CI workflow passes (green check)
- Coverage report appears as PR comment showing per-file coverage
- After branch protection: direct push to main is blocked
- After Gist setup: coverage badge shows percentage on next push to main
  </how-to-verify>
  <resume-signal>Type "approved" after verifying CI runs successfully, or describe any issues encountered.</resume-signal>
</task>

</tasks>

<verification>
1. README.md has CI and coverage badges using Shields.io (per user decision)
2. CI workflow triggers and runs successfully on the PR
3. Coverage report appears as PR comment
4. Branch protection script runs without errors (when executed)
5. All inline annotations work (lint via biome reporter, typecheck via problem matcher)
</verification>

<success_criteria>
- README.md displays 5 badges including CI and Coverage
- CI workflow passes on a real PR (lint + typecheck + test + coverage)
- Coverage PR comment shows per-file coverage with 80% threshold
- Branch protection script successfully configures main branch protection
- CI badge in README reflects actual build status after first run
</success_criteria>

<output>
After completion, create `.planning/phases/02-ci-cd-pipeline/02-02-SUMMARY.md`
</output>
