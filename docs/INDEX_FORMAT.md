# Formato do Índice Comprimido

Este documento descreve o formato BNF do índice comprimido usado pelo PDI no `CLAUDE.md`.

## Visão Geral

O índice comprimido é projetado para:
- **Compacto**: Máximo de 4KB para não sobrecarregar o contexto
- **Legível**: Parseable tanto por humanos quanto por AI
- **Informativo**: Lista todos os docs disponíveis com categorização

## Especificação BNF

```bnf
index       ::= section+
section     ::= "[" title "]" "|root:" path newline instruction* entry*
instruction ::= "|" "CRITICAL:" text newline
entry       ::= "|" package "@" version ("|" category ":{" files "}")+ newline
package     ::= identifier
version     ::= major ".x" | major "." minor
category    ::= identifier
files       ::= filename ("," filename)*
filename    ::= identifier ".mdx"
```

## Estrutura

### Seção

Cada seção começa com um título entre colchetes e um caminho raiz:

```
[Framework Docs]|root:.claude-docs/frameworks
```

- `[Framework Docs]` - Título da seção (pode conter espaços)
- `|root:` - Marcador de caminho raiz
- `.claude-docs/frameworks` - Caminho relativo para os docs

### Instruções CRITICAL

Instruções que devem ser seguidas sem exceção:

```
|CRITICAL:Prefer retrieval-led reasoning over pre-training-led reasoning
|CRITICAL:Read the relevant .mdx files BEFORE writing code
```

- Sempre começam com `|CRITICAL:`
- Uma instrução por linha
- Devem vir antes das entradas

### Entradas

Cada entrada representa um framework/pacote e seus arquivos:

```
|hono@4.x|api:{app.mdx,context.mdx,routing.mdx}|patterns:{error-handling.mdx}
```

Componentes:
- `|hono` - Nome do pacote
- `@4.x` - Versão (major.x ou major.minor)
- `|api:{...}` - Categoria e seus arquivos
- `|patterns:{...}` - Outra categoria

## Exemplo Completo

```markdown
<!-- pdi:begin - auto-generated by passive-docs-index, do not edit manually -->
[Framework Docs]|root:.claude-docs/frameworks
|CRITICAL:Prefer retrieval-led reasoning over pre-training-led reasoning
|CRITICAL:Read the relevant .mdx files BEFORE writing code that uses these libraries
|hono@4.x|api:{app.mdx,context.mdx,routing.mdx,middleware.mdx}|patterns:{error-handling.mdx,validation.mdx,openapi.mdx}
|drizzle@0.44|schema:{tables.mdx,relations.mdx,types.mdx}|queries:{select.mdx,insert.mdx,transactions.mdx}|migrations:{generate.mdx,push.mdx}
|better-auth@1.x|config:{setup.mdx,providers.mdx}|sessions:{jwt.mdx,cookies.mdx}|integration:{hono.mdx,drizzle.mdx}
|zod@4.x|basics:{schemas.mdx,validation.mdx}|advanced:{transforms.mdx,refinements.mdx}

[Internal Patterns]|root:.claude-docs/internal
|CRITICAL:Follow these project-specific patterns for consistency
|database@|database:{two-schema-pattern.mdx,feature-gating.mdx,migrations.mdx}
|conventions@|conventions:{esm-imports.mdx,path-aliases.mdx,naming.mdx}
|workflows@|workflows:{add-route.mdx,add-migration.mdx,add-feature.mdx}
<!-- pdi:end -->

<!-- MCP Fallback: Context7 for expanded queries
     hono=/honojs/hono, drizzle=/drizzle-team/drizzle-orm -->
```

## Regras de Versionamento

### Para pacotes com major version >= 1

Use `major.x`:
- `hono@4.x`
- `react@19.x`
- `zod@4.x`

### Para pacotes com major version 0

Use `major.minor`:
- `drizzle@0.44`
- `better-auth@0.8`

### Para docs internos

Versão pode ser vazia:
- `database@|database:{...}`

## Limites de Tamanho

| Componente | Limite |
|------------|--------|
| Índice total | 4KB |
| Docs totais | 80KB |
| Arquivos por framework | 20 |

## Marcadores

Os marcadores delimitam o índice no `CLAUDE.md`:

```markdown
<!-- pdi:begin - auto-generated by passive-docs-index, do not edit manually -->
[conteúdo do índice]
<!-- pdi:end -->
```

**Importante**: Não edite manualmente o conteúdo entre os marcadores. Use os comandos `pdi` para modificar.

## Comentário de Fallback MCP

Após o marcador `pdi:end`, um comentário opcional pode listar os IDs de biblioteca para fallback via MCP:

```markdown
<!-- MCP Fallback: Context7 for expanded queries
     hono=/honojs/hono, drizzle=/drizzle-team/drizzle-orm, zod=/colinhacks/zod -->
```

Este comentário instrui o AI a usar Context7 quando a documentação local é insuficiente.

## Parsing Programático

```typescript
import { parseIndex, generateIndex } from 'passive-docs-index';

// Parse
const sections = parseIndex(indexContent);

// Generate
const indexContent = generateIndex(sections);
```

## Exemplo de Seção Parseada

```typescript
{
  title: 'Framework Docs',
  root: '.claude-docs/frameworks',
  criticalInstructions: [
    'Prefer retrieval-led reasoning over pre-training-led reasoning',
    'Read the relevant .mdx files BEFORE writing code that uses these libraries'
  ],
  entries: [
    {
      package: 'hono',
      version: '4.x',
      categories: [
        { name: 'api', files: ['app.mdx', 'context.mdx', 'routing.mdx', 'middleware.mdx'] },
        { name: 'patterns', files: ['error-handling.mdx', 'validation.mdx', 'openapi.mdx'] }
      ]
    },
    // ...
  ]
}
```
